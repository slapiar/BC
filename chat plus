# PWA Chat â€“ metodika + TODO pre Copilota (onboarding, admin queue, osobnÃ© miestnosti, Ãºlohy, odznaky, hlas)

## CieÄ¾
ZjednotiÅ¥ metodiku chatu tak, aby:
- Å¾iadateÄ¾ o prÃ­stup mal jasnÃ½ flow (â€œZadaj nickname a Pripoj saâ€),
- Admin mal prehÄ¾adnÃ½ zoznam Å¾iadostÃ­ (approve/deny/wait) + vedel odpojiÅ¥/odobraÅ¥ pouÅ¾Ã­vateÄ¾a,
- kaÅ¾dÃ½ potvrdenÃ½ Älen mohol osloviÅ¥ kohokoÄ¾vek (osobnÃ© miestnosti pre kaÅ¾dÃ©ho),
- panel chatu signalizoval: kto komunikuje, kto chce hovoriÅ¥, kto mÃ¡ Ãºlohy; veci â€œpre mÅˆaâ€ svietia Äerveno,
- â€œÃºlohyâ€ fungovali priamo v chate (notifikÃ¡cie, termÃ­ny, potvrdenia â€œHotovoâ€ vÅ¡etkÃ½mi dotknutÃ½mi, finÃ¡lne potvrdenie zadÃ¡vateÄ¾om),
- beÅ¾nÃ¡ komunikÃ¡cia medzi 2 Ä¾uÄmi sa berie ako otvorenÃ¡, kÃ½m obaja nestlaÄia â€œHotovoâ€,
- hlasovÃ© diktovanie po slovensky pre textovÃ© polia v chate.

---

## 0) ZÃ¡sada (Poka-Yoke)
NiÄ nesmie â€œvisieÅ¥ naslepoâ€.
- Pending prÃ­stup je vÅ¾dy viditeÄ¾nÃ½ v Admin queue (s menom/nickname a Äasom).
- Pending zÃ¡znam musÃ­ maÅ¥ expirÃ¡cie + stav (pending/approved/denied/expired).
- PWA nesmie vytvÃ¡raÅ¥ â€œneidentifikovanÃ©â€ Å¾iadosti, ktorÃ© Admin nevie priradiÅ¥ ku konkrÃ©tnej osobe.

---

## 1) Flow: Å½iadateÄ¾ o prÃ­stup (PWA UI)
### 1.1 StavovÃ½ model na klientovi
- Ak device nie je `active`, PWA zobrazuje onboarding obrazovku:
  - text input: `nickname`
  - tlaÄidlo: **â€œZadaj svoj nickname a Pripoj saâ€**
  - po kliknutÃ­ sa volÃ¡ `POST /auth/request-access` (viÄ backend)
- AÅ¾ po ÃºspeÅ¡nom approve (device active + refresh ok) sa zobrazÃ­ chat.

### 1.2 PovinnÃ© Ãºdaje v requeste
- `device_id` (X-Device-Id)
- `nickname` (min 2 znaky, max 32)
- voliteÄ¾ne `phone_hint` (NEpÃ½taÅ¥ sa na ÄÃ­slo zo zariadenia; len ak ho user zadÃ¡)
- `client_info`: platform, app_version (voliteÄ¾nÃ©)

### 1.3 UX po odoslanÃ­ Å¾iadosti
- stav: â€œÄŒakÃ¡ na schvÃ¡lenieâ€
- zobraziÅ¥:
  - â€œZavolajte Adminovi a povedzte: Nickname + KÃ³dâ€
- kÃ³d generuje server (approval_code), PWA ho len zobrazÃ­.

---

## 2) Admin: Queue Å¾iadateÄ¾ov + akcie
### 2.1 Admin screen â€œÅ½iadosti o prÃ­stupâ€
V WP admin pridaÅ¥ menu: **Chat â†’ Å½iadosti o prÃ­stup**
ZobraziÅ¥ tabuÄ¾ku:
- created_at (Äas)
- nickname
- device_id (skrÃ¡tene)
- status: pending / waiting / denied / expired / approved
- last_seen / count pokusov (voliteÄ¾nÃ©)
Akcie na riadku:
- âœ… Approve
- â›” Deny
- ğŸ•’ Wait (oznaÄÃ­ ako â€œwaitingâ€ â€“ Admin si to odloÅ¾Ã­)
- ğŸ§¨ Expire now (okamÅ¾ite expirovaÅ¥)
- ğŸ” Detail (log, poznÃ¡mka)

### 2.2 Admin akcia â€œApproveâ€
- nastavÃ­ device status -> `active`
- priradÃ­/ vytvorÃ­ WP user (podÄ¾a internÃ©ho modelu)
- zaloÅ¾Ã­ personal room (viÄ bod 3)
- zapÃ­Å¡e audit log

### 2.3 Admin akcia â€œDenyâ€
- nastavÃ­ device status -> `denied` (alebo revoked)
- revokuje sessions (ak existujÃº)
- audit log

### 2.4 Admin akcia â€œDisconnect / Remove from chatâ€
V zozname pouÅ¾Ã­vateÄ¾ov (Chat â†’ ÄŒlenovia) pridaÅ¥:
- **Disconnect device** (revokuje sessions + status=revoked)
- **Remove user from chat** (deaktivuje chat rolu, voliteÄ¾ne soft delete jeho thread listy)
- (Hard delete len admin, s potvrdenÃ­m)

---

## 3) Metodika miestnostÃ­ (rooms)
### 3.1 Typy miestnostÃ­
A) **Shared rooms** â€“ ÃºÄelovÃ© (napr. â€œVÃ½robaâ€, â€œPredajÅˆaâ€)
B) **Personal room** pre kaÅ¾dÃ©ho Älena â€“ â€œinboxâ€ danÃ©ho Älena

### 3.2 Pravidlo oslovenia kohokoÄ¾vek
- KaÅ¾dÃ½ Älen mÃ¡ prÃ¡vo poslaÅ¥ sprÃ¡vu do **personal room** inÃ©ho Älena:
  - napr. room slug: `user:{user_id}` alebo `inbox:{user_id}`
- UI: v kontakte klik â€œNapÃ­saÅ¥â€ â†’ otvorÃ­ personal room prÃ­jemcu

### 3.3 â€œPre mÅˆaâ€ svieti Äerveno
- V paneli chatu (BadgeBar) ak poloÅ¾ka smeruje do mÃ´jho personal room a je:
  - unread message alebo open task/request
  â†’ badge background = ÄervenÃ¡ (token `--badge-for-me`)

---

## 4) Panel chatu: odznaky (badges) a kontrolky
### 4.1 Badge zdroje
Backend endpoint: `GET /threads/badges` (uÅ¾ navrhnutÃ©)
MusÃ­ vrÃ¡tiÅ¥:
- peer user
- room/thread id
- unread_count
- open_tasks_count
- open_requests_count
- active_connection flag (optional)
- `badge_state` computed server-side

### 4.2 Badge pravidlÃ¡ (priorita)
1) **for_me_urgent** (ÄervenÃ¡) â€“ urgent alebo deadline blÃ­zko, a tÃ½ka sa mÅˆa
2) urgent_task/request (oranÅ¾ovÃ¡)
3) pending_task/request (Å¾ltÃ¡)
4) unread_messages (modrÃ¡)
5) active_connection (zelenÃ¡)
6) idle (nezobrazovaÅ¥)

### 4.3 â€œKto prÃ¡ve komunikujeâ€
- definÃ­cia MVP: â€œmÃ¡ nepreÄÃ­tanÃ©â€ alebo â€œposlednÃ¡ aktivita < 2 minâ€
- zobraz v BadgeBar jemnÃ½ â€œpulse ringâ€ (CSS) pre active communication

---

## 5) Ãšlohy a poÅ¾iadavky ako â€œchat itemsâ€
### 5.1 Item typy
ZaviesÅ¥ jednotnÃ© poloÅ¾ky (event stream):
- message
- task
- request
- system

### 5.2 Ãšloha: model
- task_id
- thread_id alebo room_id (kam Ãºloha patrÃ­)
- created_by
- assignees[] (zoznam user_id, koho sa tÃ½ka)
- watchers[] (optional)
- due_at (optional)
- status: open / in_progress / done / archived
- priority: normal / high / urgent
- acknowledgements:
  - `done_by[user_id]=timestamp` (kto stlaÄil Hotovo)
- final_done_at: timestamp (nastane aÅ¾ keÄ potvrdÃ­ zadÃ¡vateÄ¾)

### 5.3 Logika â€œHotovoâ€
- KaÅ¾dÃ½ dotknutÃ½ (assignee) mÃ¡ tlaÄidlo **Hotovo**
  - klik: `POST /tasks/{id}/done` â†’ zapÃ­Å¡e done_by pre user
- ZadÃ¡vateÄ¾ (created_by) mÃ¡ tieÅ¾ **Hotovo** (finÃ¡lne potvrdenie)
- Ãšloha je vizuÃ¡lne:
  - â€œÄakÃ¡ na potvrdeniaâ€ (ak done_by neobsahuje vÅ¡etkÃ½ch assignees)
  - â€œÄakÃ¡ na finÃ¡lne potvrdenie zadÃ¡vateÄ¾omâ€ (ak vÅ¡etci assignees done, ale creator nie)
  - â€œsplnenÃ¡â€ aÅ¾ keÄ:
    - vÅ¡etci assignees done AND creator done
  - potom UI: preÅ¡krtnÃºÅ¥ + presun do Completed filter

### 5.4 BeÅ¾nÃ¡ komunikÃ¡cia (2 Ä¾udia) = otvorenÃ¡, kÃ½m obaja nedajÃº Hotovo
ImplementovaÅ¥ â€œConversation Closureâ€ pre 1:1 thread:
- thread mÃ¡ `closure_state`:
  - open
  - closed_by_me
  - closed_by_peer
  - closed (obaja)
- tlaÄidlo â€œHotovoâ€ v header 1:1 thread:
  - klik: `POST /threads/{id}/close` (per user)
- UI:
  - ak closed (obaja): thread oznaÄiÅ¥ ako â€œuzavretÃ½â€ a v zozname daÅ¥ do â€œClosedâ€
  - ak len jeden: zobraziÅ¥ â€œÄŒakÃ¡ na Hotovo od druhej stranyâ€

---

## 6) NotifikÃ¡cie a termÃ­ny
### 6.1 Zmeny Ãºlohy
KaÅ¾dÃ¡ zmena (status, due_at, done_by) generuje system item do threadu:
- â€œJano oznaÄil Hotovoâ€
- â€œTermÃ­n sa blÃ­Å¾i za 2 hodinyâ€
- â€œZadÃ¡vateÄ¾ potvrdil splnenÃ©â€

### 6.2 BlÃ­Å¾iaci sa termÃ­n
MVP:
- server cron (WP cron) kaÅ¾dÃ½ch X min:
  - nÃ¡jde tasks s due_at < now + threshold a status != done
  - vytvorÃ­ system item + badge_state nastavÃ­ urgent
- threshold: 24h a 2h (konfig)

---

## 7) Filtre v detaile threadu
V ThreadDetail pridaÅ¥ filter pills:
- All
- Messages
- Tasks
- Requests
- System
+ filter status:
- Open
- Done
- Archived

ImplementovaÅ¥ parametre:
- `GET /threads/{id}/items?type=task&status=open`

---

## 8) Soft/Hard delete
### 8.1 Soft delete
- user si skryje item alebo celÃ½ thread pre seba
- endpoint: `POST /items/{id}/soft-delete`
- pre thread: `POST /threads/{id}/hide`

### 8.2 Hard delete
- len admin
- endpoint: `DELETE /items/{id}`
- UI musÃ­ maÅ¥ confirm + fallback na soft delete pri 403

---

## 9) HlasovÃ© zadÃ¡vanie po slovensky (Speech-to-text)
### 9.1 MVP implementÃ¡cia (Web Speech API)
- PridaÅ¥ ikonku mikrofÃ³nu vedÄ¾a inputu sprÃ¡vy a vedÄ¾a tvorby Ãºlohy
- PouÅ¾iÅ¥ `SpeechRecognition` (webkitSpeechRecognition) ak je dostupnÃ©
- NastaviÅ¥:
  - `lang = 'sk-SK'`
  - `interimResults = true`
  - `continuous = false` (MVP)
- Po diktovanÃ­ vloÅ¾iÅ¥ text do inputu, user mÃ´Å¾e upraviÅ¥ a odoslaÅ¥.

### 9.2 Fallback
Ak SpeechRecognition nie je dostupnÃ©:
- skry mikrofÃ³n alebo zobraz tooltip â€œTento prehliadaÄ nepodporuje diktovanieâ€

### 9.3 BezpeÄnosÅ¥/UX
- jasnÃ¡ indikÃ¡cia â€œnahrÃ¡vamâ€ (ÄervenÃ¡ bodka)
- stop tlaÄidlo
- nezapÃ­naÅ¥ automaticky bez user akcie

---

## 10) Endpointy (sÃºhrn)
- `POST /auth/request-access` (device_id + nickname) -> pending + approval_code
- `GET /admin/access-requests` (list)
- `POST /admin/access-requests/{id}/approve`
- `POST /admin/access-requests/{id}/deny`
- `POST /admin/users/{user_id}/disconnect`
- `GET /threads/badges`
- `GET /threads/{id}/items`
- `POST /threads/{id}/items` (message/task/request)
- `POST /tasks/{id}/done`
- `POST /threads/{id}/close`
- `POST /items/{id}/soft-delete`
- `DELETE /items/{id}` (admin)
- `POST /threads/{id}/mark-read`

---

## 11) AkceptaÄnÃ© kritÃ©riÃ¡ (must-pass)
1) NepripojenÃ½ user vidÃ­ iba onboarding s nickname + pripoj sa.
2) Admin vidÃ­ queue pending Å¾iadostÃ­ s nickname + Äasom + akciami approve/deny/wait.
3) Po approve sa user dostane do chatu bez ÄalÅ¡Ã­ch krokov.
4) KaÅ¾dÃ½ Älen mÃ´Å¾e otvoriÅ¥ personal room kohokoÄ¾vek.
5) â€œPre mÅˆaâ€ notifikÃ¡cie svietia Äerveno v BadgeBar.
6) Task â€œHotovoâ€ funguje: splnenÃ¡ aÅ¾ po potvrdenÃ­ vÅ¡etkÃ½ch assignees + creator.
7) 1:1 thread sa oznaÄÃ­ uzavretÃ½ aÅ¾ keÄ obaja dajÃº Hotovo.
8) HlasovÃ© diktovanie funguje v Chrome/Android pre sk-SK; fallback je bezpeÄnÃ½.

---

## ImplementaÄnÃ¡ stratÃ©gia (aby sme sa nezasekli)
FÃ¡za 1: Admin queue + onboarding nickname + approve/deny/wait + personal rooms
FÃ¡za 2: BadgeBar vÃ½poÄty + â€œpre mÅˆaâ€ ÄervenÃ© + mark-read
FÃ¡za 3: Tasks + done workflow + deadline cron + system events
FÃ¡za 4: Conversation closure (Hotovo pre 1:1)
FÃ¡za 5: Soft/hard delete
FÃ¡za 6: Speech-to-text (sk-SK)

Copilot: postupovaÅ¥ striktne po fÃ¡zach, bez refactoru mimo fÃ¡zy.